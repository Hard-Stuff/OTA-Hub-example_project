stages:
- build
- release

variables:
  GIT_DEPTH: "2"

#############################################
# Build all PlatformIO environments
#############################################
build_firmware:
  stage: build
  image: python:3.11
  rules:
  - if: $CI_COMMIT_TAG
  before_script:
  - pip install platformio
  script:
  - echo "=== Building firmware for tag $CI_COMMIT_TAG ==="
  - export FIRMWARE_VERSION="$CI_PIPELINE_ID"
  - export PLATFORMIO_BUILD_FLAGS="-DOTA_BUILT_ON_GITLAB -DFIRMWARE_VERSION=$FIRMWARE_VERSION"
  - echo "PlatformIO build flags $PLATFORMIO_BUILD_FLAGS"

  # Detect environments to build
  - echo "Detecting environments in platformio.ini..."
  - ENV_LIST=$(awk '/^\[env:/{env=$0} /^# -- CICD IGNORE BUILD --/{exit} {if(env){print substr(env,6,length(env)-6); env=""}}' platformio.ini)
  - echo "Environments detected to build:"
  - for ENV in $ENV_LIST; do echo "  - $ENV"; done

  # Build each environment
  - |
    for ENV in $ENV_LIST; do
      echo "---- Building environment: $ENV ----"
      pio run -e "$ENV"

      mkdir -p artifacts/$ENV
      for FILE in firmware.bin partitions.bin bootloader.bin; do
        SRC=".pio/build/$ENV/$FILE"
        DEST="artifacts/$ENV/${ENV}_${FILE}"
        if [ -f "$SRC" ]; then
          cp "$SRC" "$DEST"
          echo "Copied $SRC -> $DEST"
        else
          echo "Warning: $SRC does not exist, skipping."
        fi
      done
    done

  artifacts:
    paths:
    - artifacts/
    expire_in: 2 weeks

#############################################
# Upload assets to GitLab Release
#############################################
upload_release_assets:
  stage: release
  image: alpine:latest
  needs: [ build_firmware ]
  rules:
  - if: $CI_COMMIT_TAG
  script:
  - echo "=== Uploading artifacts for tag $CI_COMMIT_TAG ==="
  - apk add --no-cache curl

  # Ensure the release exists
  - |
    echo "Creating release..."
    curl --silent --request POST --header "JOB-TOKEN: $CI_JOB_TOKEN" \
      --header "Content-Type: application/json" \
      --data "{\"name\": \"$CI_COMMIT_TAG\", \"tag_name\": \"$CI_COMMIT_TAG\"}" \
      "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/releases" || true

  # Determine environments from artifacts folder and Upload all artifacts
  - ENV_LIST=$(ls artifacts)
  - |
    for ENV in $ENV_LIST; do
      echo "Processing environment: $ENV"
      for FILE in artifacts/$ENV/*; do
        if [ ! -f "$FILE" ]; then continue; fi
        
        BASENAME=$(basename "$FILE")
        PACKAGE_URL="${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/${ENV}/${CI_COMMIT_TAG}/${BASENAME}"
        
        echo "Uploading $BASENAME to Package Registry..."
        
        HTTP_CODE=$(curl --silent --write-out "%{http_code}" --request PUT -o /dev/null \
          --header "JOB-TOKEN: $CI_JOB_TOKEN" \
          --upload-file "$FILE" \
          "$PACKAGE_URL")

        if [ "$HTTP_CODE" -ne 201 ]; then
          echo "Error uploading $BASENAME. Code: $HTTP_CODE"
          exit 1
        fi

        echo "Linking $BASENAME to Release..."
        LINK_URL="${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/releases/${CI_COMMIT_TAG}/assets/links"
        curl --silent --request POST --header "JOB-TOKEN: $CI_JOB_TOKEN" \
          --header "Content-Type: application/json" \
          --data "{\"name\": \"$BASENAME\", \"url\": \"$PACKAGE_URL\", \"link_type\":\"package\"}" \
          "$LINK_URL"
          
      done
    done
